

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Data Management</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body { background-color: #f8f9fa; }
        .crud-container { max-width: 1200px; margin: 2rem auto; padding: 2rem; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .crud-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .crud-header h1 { margin: 0; border: none; padding: 0; font-size: 2rem; }
        .crud-actions { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        #tableSelector, #searchInput { height: 48px; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; }
        #addNewBtn { height: 48px; padding: 10px 15px; width: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; font-size: 0.95rem; }
        .data-table th, .data-table td { padding: 12px 15px; border: 1px solid #dee2e6; text-align: left; vertical-align: middle; white-space: nowrap; }
        .data-table thead { background-color: #e9ecef; }
        .data-table thead th { position: relative; cursor: pointer; }
        .data-table thead th .sort-arrow { position: absolute; top: 50%; transform: translateY(-50%); }
        .data-table .actions { width: 100px; text-align: center; }
        .data-table .actions .fas { cursor: pointer; margin: 0 8px; font-size: 1.1rem; }
        .fa-edit { color: #ffc107; }
        .fa-trash-alt { color: #dc3545; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close-button { position: absolute; top: 10px; right: 20px; font-size: 2rem; cursor: pointer; }
        .modal-content .form-group { margin-bottom: 1rem; }
        #crudForm button[type="submit"] { width: 100%; margin-top: 1rem; }
        .pagination-controls button { margin: 0 5px; padding: 5px 10px; cursor: pointer; border: 1px solid #dee2e6; background-color: white; border-radius: 4px; }
        .pagination-controls button.active { font-weight: bold; background-color: #007bff; color: white; border-color: #007bff; }
        .pagination-controls button:hover:not(.active) { background-color: #e9ecef; border-color: #adb5bd; }
        .btn-import { 
            height: 48px; 
            padding: 10px 15px; 
            background-color: #28a745; 
            color: white; 
            border: none;
            border-radius: 6px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .btn-logout{
            height: 28px; 
            padding: 10px 15px; 
            background-color: #ff0000; 
            color: white; 
            border: none;
            border-radius: 6px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="crud-container">
        <div class="crud-header">
            <h1>Data Management</h1>
            <div>
                <span>Welcome, <strong>{{ current_user.full_name }}</strong> ({{ current_user.role.role_name }})!</span>
                <a href="{{ url_for('auth.logout_api') }}" style=" text-decoration: none; color: white;" class="btn-logout">Logout</a>
            </div>
        </div>

        <div class="crud-actions">
            <select id="tableSelector"></select>
            <input type="text" id="searchInput" placeholder="Search in table...">
            <button id="addNewBtn" class="btn">
                <i class="fas fa-plus"></i> Add New
            </button>
            <a href="{{ url_for('main.import_page') }}" class="btn-import">
                <i class="fas fa-file-import"></i> Import CSV
            </a>
        </div>

        <div style="overflow-x: auto;">
            <div id="dataTableContainer"></div>
        </div>
        <div id="crudPagination" class="pagination-controls" style="text-align: center; margin-top: 20px;"></div>
    </div>

    <div id="formModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h2 id="modalTitle"></h2>
            <form id="crudForm"></form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const userRole = '{{ current_user.role.role_name.lower() if current_user.role else "viewer" }}';
    const loggedInUserId = parseInt('{{ current_user.user_id }}', 10);
    const tableSelector = document.getElementById('tableSelector');
    const dataTableContainer = document.getElementById('dataTableContainer');
    const addNewBtn = document.getElementById('addNewBtn');
    const searchInput = document.getElementById('searchInput');
    const formModal = document.getElementById('formModal');
    const modalTitle = document.getElementById('modalTitle');
    const crudForm = document.getElementById('crudForm');
    const closeModalBtn = formModal.querySelector('.modal-close-button');
    
    let crudCurrentPage = 1;
    const crudPageSize = 100;

    let sortColumn = null;
    let sortDirection = 'asc';

    let currentTable = '';
    let currentData = [];
    let currentItemId = null;
    let allRolesList = [];

    const setupTableSelector = () => {
        const tables = {
            items: "Items",
            staff: "Staff",
            transactions: "Transactions"
        };
        if (userRole === 'super admin') {
            tables.users = "Users";
            tables.logs = "Audit Logs"; //
        }
        
        tableSelector.innerHTML = '';
        for (const [value, text] of Object.entries(tables)) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            tableSelector.appendChild(option);
        }
        currentTable = tableSelector.value;
    };

    const updateUIToolsVisibility = () => {
        if (userRole === 'viewer' || currentTable === 'transactions' || currentTable === 'logs') {
            addNewBtn.style.display = 'none';
        } else {
            addNewBtn.style.display = 'inline-block';
        }
        
        const importBtn = document.querySelector('.btn-import');
        if (userRole !== 'admin' && userRole !== 'super admin') {
            if(importBtn) importBtn.style.display = 'none';
        } else {
            if(importBtn) importBtn.style.display = 'inline-flex';
        }
    };

    const fetchInitialData = async () => {
        if (userRole === 'super admin') {
            try {
                const rolesResponse = await fetch('/api/roles');
                if (rolesResponse.ok) {
                    allRolesList = await rolesResponse.json();
                } else {
                    console.error('Could not fetch roles');
                }
            } catch (error) {
                console.error('Error fetching roles:', error);
            }
        }
        await fetchData(currentTable);
    };
    
    const fetchData = async (tableName) => {
        try {
            const response = await fetch(`/api/${tableName}`);
            if (!response.ok) {
                 const err = await response.json();
                 throw new Error(err.message || 'Network response was not ok');
            }
            currentData = await response.json();
            crudCurrentPage = 1;
            sortColumn = getPrimaryKeyField(tableName);
            sortDirection = 'asc';
            renderTable(tableName, currentData);
        } catch (error) {
            dataTableContainer.innerHTML = `<p style="color:red;">Error fetching data: ${error.message}</p>`;
        }
    };

    const getPrimaryKeyField = (tableName) => {
        const pkMap = { items: 'item_code', staff: 'staff_id', users: 'user_id', transactions: 'transaction_id',logs: 'log_id' };
        return pkMap[tableName] || 'id';
    };
    
    const getSortedHeaders = (headers, pkField) => {
        const otherHeaders = headers.filter(h => h !== pkField && h !== 'role_name').sort();
        return [pkField, ...otherHeaders];
    };
    
    window.handleSort = (columnKey) => {
        if (sortColumn === columnKey) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = columnKey;
            sortDirection = 'asc';
        }
        renderTable(currentTable, currentData);
    };

    const paginateData = (data) => {
        const startIndex = (crudCurrentPage - 1) * crudPageSize;
        return data.slice(startIndex, startIndex + crudPageSize);
    };

   const renderTable = (tableName, data) => {
        const paginationContainer = document.getElementById('crudPagination');
        
        if (!data || data.length === 0) {
            dataTableContainer.innerHTML = '<p>No data found.</p>';
            paginationContainer.innerHTML = '';
            return;
        }

        const pkField = getPrimaryKeyField(tableName);
        let headers;

        if (tableName === 'transactions') {
            headers = [
                'transaction_id', 'hn', 'patient_type','patient_name', 'transaction_date', 'doctor', 'consultant', 
                'total_amount', 'deposit_amount', 'payment_method', 'review_status', 'comment', 'created_by'
            ];
        } else {
            const originalHeaders = Object.keys(data[0]);
            headers = getSortedHeaders(originalHeaders, pkField);
        }

        if (sortColumn) {
            data.sort((a, b) => {
                const valA = a[sortColumn];
                const valB = b[sortColumn];
                if (valA == null) return 1;
                if (valB == null) return -1;
                let comparison = 0;
                if (typeof valA === 'string') {
                    comparison = valA.localeCompare(valB, 'th');
                } else {
                    comparison = valA > valB ? 1 : (valA < valB ? -1 : 0);
                }
                return sortDirection === 'asc' ? comparison : -comparison;
            });
        }
        
        const paginatedData = paginateData(data);

        let tableHTML = '<table class="data-table"><thead><tr>';
        headers.forEach(h => {
            let arrow = '';
            if (h === sortColumn) {
                arrow = sortDirection === 'asc' ? '▲' : '▼';
            }
            tableHTML += `<th onclick="handleSort('${h}')">${h.replace(/_/g, ' ')} <span class="sort-arrow">${arrow}</span></th>`;
        });
        
        // --- ส่วนที่แก้ไข (จุดที่ 1) ---
        if (tableName !== 'logs') {
            tableHTML += '<th>Actions</th>';
        }
        tableHTML += '</tr></thead><tbody>';

        paginatedData.forEach(row => {
            tableHTML += '<tr>';
            headers.forEach(h => {
                let cellValue = row[h];
                if (h === 'is_active') {
                    cellValue = cellValue ? 'Active' : 'Inactive';
                }
                tableHTML += `<td>${cellValue === null || cellValue === undefined ? '' : cellValue}</td>`;
            });
            
            // --- ส่วนที่แก้ไข (จุดที่ 2) ---
            if (tableName !== 'logs') {
                const pkValue = row[pkField];
                let actionsHTML = '';
                
                if ((tableName === 'transactions' && (userRole === 'super admin' || userRole === 'admin')) || 
                    (tableName !== 'transactions' && userRole !== 'viewer')) {
                     actionsHTML += `<i class="fas fa-edit" onclick="handleEdit('${pkValue}')" title="Edit/View"></i>`;
                }

                if ((userRole === 'super admin' || userRole === 'admin') && (tableName !== 'users' || loggedInUserId != pkValue)) {
                     actionsHTML += `<i class="fas fa-trash-alt" onclick="handleDelete('${pkValue}')" title="Delete"></i>`;
                }
                
                tableHTML += `<td class="actions">${actionsHTML}</td>`;
            }
            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        dataTableContainer.innerHTML = tableHTML;
        renderCrudPagination(Math.ceil(data.length / crudPageSize));
    };
    /////-----------------------------------
    const getSingularName = (tableName) => {
        if (tableName === 'staff') return 'Staff';
        if (tableName.endsWith('s')) return tableName.slice(0, -1);
        return tableName;
    };

    const renderForm = (tableName, item = {}) => {
        const pkField = getPrimaryKeyField(tableName);
        let formHTML = '';

        if (tableName === 'transactions') {
            modalTitle.textContent = `View Transaction: ${item[pkField]}`;
            let transactionHeaders = Object.keys(item);
            transactionHeaders.forEach(header => {
                const value = item[header] ?? '';
                formHTML += `<div class="form-group"><label style="text-transform: capitalize;">${header.replace(/_/g, ' ')}</label><textarea class="form-control" readonly>${value}</textarea></div>`;
            });
            crudForm.innerHTML = formHTML;
            return;
        }

        let headers;
        if (currentData.length > 0) {
            headers = getSortedHeaders(Object.keys(currentData[0]), pkField);
        } else {
             if(tableName === 'users') headers = ['user_id', 'username', 'full_name', 'role_id', 'is_active'];
             else if(tableName === 'staff') headers = ['staff_id', 'name_th', 'name_en', 'staff_role'];
             else if(tableName === 'items') headers = ['item_code', 'name_th', 'price_opd', 'price_ipd', 'price_foreign_opd', 'price_foreign_ipd', 'price_staff'];
        }

        headers.forEach(header => {
            if (header === pkField) {
                 if(currentItemId) formHTML += `<div class="form-group"><label>${header}</label><input type="text" class="form-control" value="${item[header] || ''}" readonly></div>`;
                 else formHTML += `<div class="form-group"><label>${header}</label><input type="text" id="${header}" name="${header}" class="form-control" required></div>`;
            } else if (tableName === 'users' && header === 'role_id') {
                let selectHTML = `<div class="form-group"><label>Role</label><select id="role_id" name="role_id" class="form-control">`;
                allRolesList.forEach(role => {
                    selectHTML += `<option value="${role.role_id}" ${role.role_id === item.role_id ? 'selected' : ''}>${role.role_name}</option>`;
                });
                formHTML += selectHTML + '</select></div>';
            } else if (tableName === 'users' && header === 'is_active') {
                formHTML += `<div class="form-group"><label>Active Status</label><select id="is_active" name="is_active" class="form-control"><option value="1" ${!item.is_active === false ? 'selected' : ''}>Active</option><option value="0" ${item.is_active === false ? 'selected' : ''}>Inactive</option></select></div>`;
            } else if (tableName === 'staff' && header === 'staff_role') {
                const val = item[header] || '';
                formHTML += `<div class="form-group"><label>Staff Role</label><select id="staff_role" name="staff_role" class="form-control"><option value="Consultant" ${val === 'Consultant' ? 'selected' : ''}>Consultant</option><option value="Doctor" ${val === 'Doctor' ? 'selected' : ''}>Doctor</option></select></div>`;
            } else if (header !== 'role_name') {
                 formHTML += `<div class="form-group"><label style="text-transform: capitalize;">${header.replace(/_/g, ' ')}</label><input type="text" id="${header}" name="${header}" class="form-control" value="${item[header] !== undefined ? item[header] : ''}"></div>`;
            }
        });

        if (tableName === 'users') {
             formHTML += `<div class="form-group"><label>Password</label><input type="password" id="password" name="password" class="form-control" placeholder="${currentItemId ? 'Leave blank to keep current' : 'Required'}"></div>`;
        }
        
        formHTML += '<button type="submit" class="btn">Save</button>';
        crudForm.innerHTML = formHTML;
    };

    const renderCrudPagination = (totalPages) => {
        const paginationContainer = document.getElementById('crudPagination');
        if (totalPages <= 1) {
            paginationContainer.innerHTML = '';
            return;
        }
        let paginationHTML = '';
        if (crudCurrentPage > 1) {
            paginationHTML += `<button onclick="handleCrudPageChange(${crudCurrentPage - 1})">&laquo; Prev</button>`;
        }
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `<button class="${i === crudCurrentPage ? 'active' : ''}" onclick="handleCrudPageChange(${i})">${i}</button>`;
        }
        if (crudCurrentPage < totalPages) {
            paginationHTML += `<button onclick="handleCrudPageChange(${crudCurrentPage + 1})">Next &raquo;</button>`;
        }
        paginationContainer.innerHTML = paginationHTML;
    };

    window.handleCrudPageChange = (newPage) => {
        crudCurrentPage = newPage;
        const searchTerm = searchInput.value.toLowerCase();
        const dataToRender = searchTerm ? 
            currentData.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(searchTerm))) : 
            currentData;
        renderTable(currentTable, dataToRender);
    };

    tableSelector.addEventListener('change', () => {
        currentTable = tableSelector.value;
        searchInput.value = '';
        updateUIToolsVisibility();
        fetchData(currentTable);
    });
    
    searchInput.addEventListener('input', (e) => {
        crudCurrentPage = 1;
        const searchTerm = e.target.value.toLowerCase();
        const filteredData = currentData.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(searchTerm)));
        renderTable(currentTable, filteredData);
    });

    addNewBtn.addEventListener('click', () => {
        currentItemId = null;
        modalTitle.textContent = `Add New ${getSingularName(currentTable)}`;
        renderForm(currentTable, {}); 
        formModal.style.display = 'flex';
    });

    closeModalBtn.addEventListener('click', () => formModal.style.display = 'none');
    
    crudForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        if (currentItemId && data.password === '') {
            delete data.password;
        }
        const url = currentItemId ? `/api/${currentTable}/${currentItemId}` : `/api/${currentTable}`;
        const method = currentItemId ? 'PUT' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
                formModal.style.display = 'none';
                await fetchData(currentTable);
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            alert(`Save failed: ${error.message}`);
        }
    });

    window.handleEdit = (itemId) => {
        const pkField = getPrimaryKeyField(currentTable);
        const item = currentData.find(d => String(d[pkField]) === String(itemId));
        if (!item) return;
        currentItemId = itemId;
        modalTitle.textContent = `Edit ${getSingularName(currentTable)}`;
        renderForm(currentTable, item);
        formModal.style.display = 'flex';
    };

    window.handleDelete = async (itemId) => {
        if (currentTable === 'users' && loggedInUserId == itemId) {
            alert("You cannot delete your own account.");
            return;
        }
        
        if (confirm(`Are you sure you want to delete this item (${itemId})? This action cannot be undone.`)) {
            try {
                const response = await fetch(`/api/${currentTable}/${itemId}`, { method: 'DELETE' });
                const result = await response.json();
                if (response.ok) {
                    await fetchData(currentTable);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                alert(`Delete failed: ${error.message}`);
            }
        }
    };
    
    setupTableSelector();
    updateUIToolsVisibility();
    fetchInitialData();
});
</script>

</body>
</html>