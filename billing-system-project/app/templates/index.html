<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Patient Information & Billing System</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet"> -->

    <link rel="icon" href="{{ url_for('static', filename='1.png') }}" type="image/png" sizes="32x32">
    <link rel="mask-icon" href="{{ url_for('static', filename='1.png') }}" color="#0056B3">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='1.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='1.png') }}" type="image/x-icon">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='1.png') }}">
    <meta name="msapplication-TileColor" content="#0056B3">

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.0/dist/signature_pad.umd.min.js"></script>
</head>

<body>

    <header class="page-header no-print">
        <div class="logo-container">
           <a href="{{ url_for('main.index') }}"> <img src="{{ url_for('static', filename='1.png') }}" alt="inZ Hospital Logo"> </a>
            <p class="logo-text"></p>
        </div>
        <h1 class="system-title">Patient & Billing System</h1>
    </header>

    <div class="main-container no-print">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('mainTab')">1. Patient, Products &amp; Billing</button>
            <button class="tab-button" onclick="openTab('receiptTab')">2. Receipt</button>
            <button class="tab-button" onclick="loadTransactionHistory(); openTab('historyTab')">3. History</button>
        </div>

        <div id="mainTab" class="tab active">
            <form id="mainForm">
            <div class="section">
                <h2>ข้อมูลผู้ป่วย</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstName">ชื่อจริง:</label>
                        <input type="text" id="firstName" placeholder="ชื่อจริง" autofocus>
                    </div>
                    <div class="form-group">
                        <label for="lastName">นามสกุล:</label>
                        <input type="text" id="lastName" placeholder="นามสกุล">
                    </div>
                    <div class="form-group">
                        <label for="gender">เพศ:</label>
                        <select id="gender">
                            <option value="">-- ระบุเพศ --</option>
                            <option value="ชาย">ชาย</option>
                            <option value="หญิง">หญิง</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="patientHN">HN (เลขประจำตัวคนไข้)</label>
                        <input type="text" id="patientHN" placeholder="ตัวอย่าง: 12-34-567890" maxlength="12">
                    </div>
                    <div class="form-group">
                        <label for="patientType">ประเภทผู้ป่วย:</label>
                        <select id="patientType">
                            <option value="opd">OPD (ผู้ป่วยนอก)</option>
                            <option value="ipd">IPD (ผู้ป่วยใน)</option>
                            <option value="foreign_opd">ผู้ป่วยนอกต่างชาติ</option>
                            <option value="foreign_ipd">ผู้ป่วยในต่างชาติ</option>
                            <option value="staff">พนักงาน</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="patientAge">อายุ:</label>
                        <input type="number" id="patientAge" placeholder="อายุ (ปี)" min="0">
                    </div>
                    <div class="form-group">
                        <label for="doctorName">ชื่อแพทย์:</label>
                        <select id="doctorName">
                            <option value="">-- เลือกแพทย์ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="consultant">ผู้ให้คำปรึกษา:</label>
                        <select id="consultant">
                            <option value="">-- เลือกผู้ให้คำปรึกษา --</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="section">
                <h2>Courses</h2>
                <div class="search-container" style="margin-top: 20px;">
                    <div class="quick-search-buttons">
                        <button class="quick-search-btn" onclick="quickSearch('IV')">IV</button>
                        <button class="quick-search-btn" onclick="quickSearch('Syringe')">Syringe</button>
                        <button class="quick-search-btn" onclick="quickSearch('Gauze')">Gauze</button>
                        <button class="quick-search-btn" onclick="quickSearch('Alcohol')">Alcohol</button>
                        <button class="quick-search-btn" onclick="quickSearch('แพ็คเกจ')">แพ็คเกจ</button>
                    </div>
                    <div class="search-input-container">
                        <input type="text" id="searchProduct" placeholder="ค้นหาสินค้าด้วยชื่อ หรือรหัส..."
                            oninput="searchProducts()" autocomplete="off">
                        <button class="clear-search" onclick="clearSearch()">×</button>
                    </div>
                    <div id="searchResults"
                        style="border: 1px solid #ddd; max-height: 200px; overflow-y: auto; margin-top: 5px;"></div>
                </div>

                <div id="cart">
                    <h3>แพ็คเกจ</h3>
                    <table id="cartTable">
                        <thead>
                            <tr>
                                <th>สินค้า</th>
                                <th>รหัสสินค้า</th>
                                <th>ราคา</th>
                                <th>จำนวน</th>
                                <th>รวม</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="cartItems"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right;"><strong>ยอดรวมสินค้า:</strong></td>
                                <td id="cartTotal">0.00 บาท</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>การเรียกเก็บและชำระเงิน </h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="depositAmount">เงินมัดจำที่ชำระ:</label>
                        <input type="number" id="depositAmount" placeholder="0.00" value="0"
                            oninput="updateBillingSummary()">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>วิธีชำระเงิน:</label>
                        <div class="checkbox-group">
                            <input type="radio" id="payCash" name="paymentMethod" value="เงินสด" checked> <label
                                for="payCash">เงินสด</label>
                            <input type="radio" id="payTransfer" name="paymentMethod" value="เงินโอน"> <label
                                for="payTransfer">เงินโอน</label>
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>สถานะรีวิว:</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="statusDeposit" name="reviewStatus" value="มัดจำ"> <label
                                for="statusDeposit">มัดจำ</label>
                            <input type="checkbox" id="statusEye" name="reviewStatus" value="ทำตา"> <label
                                for="statusEye">ทำตา</label>
                            <input type="checkbox" id="statusReview" name="reviewStatus" value="รีวิว"> <label
                                for="statusReview">รีวิว</label>
                            <input type="checkbox" id="statusNoReview" name="reviewStatus" value="ไม่รีวิว"> <label
                                for="statusNoReview">ไม่รีวิว</label>
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="comment">หมายเหตุ:</label>
                        <textarea id="comment" rows="3" placeholder="เพิ่มหมายเหตุเพิ่มเติม..."></textarea>
                    </div>
                </div>
            </div>

            <div class="section signature-sections-row"> <div class="signature-column"> <h2 class="signature-title-inline">ลายเซ็นผู้ให้คำปรึกษา</h2> <div class="signature-pad-group"> <label for="consultantSignatureCanvas">ลงลายเซ็นผู้ให้คำปรึกษา:</label>
                        <canvas id="consultantSignatureCanvas" width="400" height="250"></canvas>
                        <div class="signature-buttons"> <button type="button" class="secondary" onclick="clearSignature()">ล้างลายเซ็น</button>
                            <button type="button" onclick="saveSignature()">บันทึกลายเซ็น</button>
                        </div>
                        <img id="consultantSignaturePreview" src="" alt="Consultant Signature Preview"
                            style="max-width: 100%; height: auto; display: none; margin-top: 10px; border: 1px dashed #ccc;">
                    </div>
                </div>

                <div class="signature-column"> <h2 class="signature-title-inline">ลายเซ็นผู้ป่วย</h2> <div class="signature-pad-group"> <label for="patientSignatureCanvas">ลงลายเซ็นผู้ป่วย:</label>
                        <canvas id="patientSignatureCanvas" width="400" height="250"></canvas>
                        <div class="signature-buttons"> <button type="button" class="secondary" onclick="clearPatientSignature()">ล้างลายเซ็น</button>
                            <button type="button" onclick="savePatientSignature()">บันทึกลายเซ็น</button>
                        </div>
                        <img id="patientSignaturePreview" src="" alt="Patient Signature Preview"
                            style="max-width: 100%; height: auto; display: none; margin-top: 10px; border: 1px dashed #ccc;">
                    </div>
                </div>
            </div>
            <div id="billingSummary">
                <h4>สรุปยอดชำระ (ตัวอย่าง)</h4>
                <hr>
                <p><strong><span>ยอดรวมทั้งหมด:</span> <span id="summaryGrandTotal">0.00 บาท</span></strong>
                </p>
                <p><span>- เงินมัดจำที่ชำระ:</span> <span id="summaryDeposit">0.00 บาท</span></p>
                <hr>
                <p><strong><span>ยอดค้างชำระ:</span> <span id="summaryOutstanding">0.00 บาท</span></strong></p>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button onclick="generateReceipt()">สร้างใบเสร็จ & บันทึก →</button>
            </div>
            </form>
        </div>

        <div id="receiptTab" class="tab">
            <button class="back no-print" onclick="openTab('mainTab')">← กลับไปหน้าหลัก</button>
            <div class="receipt-preview-container"></div>
            <div class="no-print" style="margin-top: 30px; text-align: right;">
                <button onclick="printMainReceipt()">🖨️ พิมพ์ใบเสร็จเต็ม</button>
                <button class="back" onclick="resetFlow()">ผู้ป่วยใหม่</button>
            </div>
        </div>

        <div id="historyTab" class="tab">
            <div class="history-header">
                <h2>ประวัติการทำรายการ</h2>
                <i class="fas fa-cog" id="login-icon" title="Admin Login"></i>
            </div>
            <input type="text" id="historySearch" placeholder="ค้นหาด้วยชื่อผู้ป่วย, แพทย์ หรือวันที่..."
                oninput="searchHistory()" style="width: 100%; margin-bottom: 20px;">
            <div id="historyResults">
                <p>กำลังโหลดประวัติ...</p>
            </div>
            <div id="historyPagination" class="pagination-controls" style="text-align: center; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="receipt" class="print-area">
        <div class="receipt-body">
            <h2>ใบประเมินราคา</h2>
            <hr>
            <p><strong>รหัสใบเสร็จ:</strong> <span data-field="receiptId"></span> | <strong>วันที่:</strong> <span
                    data-field="receiptDate"></span></p>
            <div class="receipt-grid">
                <div>
                    <h4>รายละเอียดผู้ป่วย</h4>
                    <p><strong>ชื่อ:</strong> <span data-field="receiptName"></span></p>
                    <p><strong>HN:</strong> <span data-field="receiptHN"></span></p>
                    <p><strong>อายุ:</strong> <span data-field="receiptAge"></span></p>
                    <p><strong>ประเภท:</strong> <span data-field="receiptType"></span></p>
                    <p><strong>เพศ:</strong> <span data-field="receiptGender"></span></p>
                </div>
                <div>
                    <h4>รายละเอียดการรักษา</h4>
                    <p><strong>แพทย์:</strong> <span data-field="receiptDoctor"></span></p>
                    <p><strong>ผู้ให้คำปรึกษา:</strong> <span data-field="receiptConsultant"></span></p>
                </div>
            </div>
            <h3>รายการ & ค่าใช้จ่าย</h3>
            <table id="receiptItemsTable_print">
                <thead>
                    <tr>
                        <th>รายการ</th>
                        <th>รหัสสินค้า</th>
                        <th>ราคา</th>
                        <th>จำนวน</th>
                        <th>รวม</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="receipt-footer">
            <div class="payment-info">
                <h4>ข้อมูลการชำระเงิน</h4>
                <p><strong>วิธีชำระเงิน:</strong> <span data-field="receiptPaymentMethod"></span></p>
                <p><strong>สถานะรีวิว:</strong> <span data-field="receiptReviewStatus"></span></p>
                <p><strong>หมายเหตุ:</strong> <span data-field="comment"></span></p>
                <div class="signature-group" style="margin-top: 30px;">
                    <div class="signature" style="margin-bottom: 5px;">
                        <img data-field="receiptPatientSignature" src="" alt="Patient's Signature" class="signature-img">
                        <p style="margin: 0;">...............................</p>
                        <p>ลายเซ็นผู้ป่วย</p>
                    </div>
                    <div class="signature consultant-signature-print">
                        <img data-field="receiptConsultantSignature" src="" alt="Consultant's Signature" class="signature-img">
                        <p style="margin: 0;">...............................</p>
                        <p>ลายเซ็นผู้ให้คำปรึกษา</p>
                    </div>
                </div>
            </div>
            <div class="payment-details">
                <h4>รายละเอียดการชำระเงิน</h4>
                <table class="receipt-summary-table">
                    <tbody>
                        <tr>
                            <td>ยอดรวมสินค้า:</td>
                            <td><span data-field="receiptSubtotal">0.00</span> บาท</td>
                        </tr>
                        <tr style="font-weight: bold; border-top: 1px solid #333; border-bottom: 1px solid #333;">
                            <td>ยอดรวมทั้งหมด:</td>
                            <td><span data-field="receiptGrandTotal">0.00</span> บาท</td>
                        </tr>
                        <tr style="font-weight: bold;">
                            <td>เงินมัดจำที่ชำระ:</td>
                            <td><span data-field="receiptDeposit">0.00</span> บาท</td>
                        </tr>
                        <tr style="font-weight: bold; font-size: 1.1em; color: #c0392b;">
                            <td>ยอดค้างชำระ:</td>
                            <td><span data-field="receiptOutstanding">0.00</span> บาท</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="receipt-note">
            <p><strong>หมายเหตุ:</strong></p>
            <ul>
                <li>กรุณาตรวจสอบรายการให้ถูกต้อง</li>
                <li>ใบเสร็จรับเงินฉบับนี้จะสมบูรณ์ต่อเมื่อมีลายเซ็นผู้รับเงินครบถ้วน</li>
                <li>เวลาทำการ: ทุกวัน 08.00 - 20.00 น.</li>
                <li>ช่องทางการติดต่อสอบถาม 02-055-8888</li>
            </ul>
        </div>
        <div class="receipt-document-footer">
            <span data-field="footerText">inZ Hospital</span>
            <span data-field="footerPage">โรงพยาบาลเฉพาะทางจักษุ</span>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h2>Admin Login</h2>
            <p id="login-error-message" class="error-text"></p>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-submit-button">Login</button>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>

</html>