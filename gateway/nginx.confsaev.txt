# Main Nginx Configuration - Final Version

# Server block to redirect all HTTP traffic to HTTPS
# include /etc/nginx/nginx.conf;

# เพิ่มคำสั่งนี้เพื่อปิดการแสดงเวอร์ชัน
# ควรใส่ไว้ใน http block

server_tokens off;

server {
    listen 80;
    server_name localhost;
    return 301 https://$host$request_uri;
}

# The main server block that handles all application traffic via HTTPS
server {
    listen 443 ssl;
    server_name localhost;
    charset utf-8;

    # SSL Certificate Configuration
    ssl_certificate /etc/nginx/certs/local.pem;
    ssl_certificate_key /etc/nginx/certs/local-key.pem;

    client_max_body_size 50m;

    # Location 1: The main landing page (the lobby)
    location / {
        root   /usr/share/nginx/html;
        index  index.html;
    }

    # --- START: THE FIX ---
    # We will now create specific locations for each part of the application
    # to ensure Nginx knows where to send every request.

    # Location 2: For static files (CSS, JS, images)
    location /static/ {
        proxy_pass http://billing_app:5000/static/;
    }

    # Location 3: For all API calls
    location /api/ {
        proxy_pass http://billing_app:5000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Location 4: For the main application pages (like /crud, /edit)
    # This will catch any other top-level paths and send them to Flask.
    # Note: This requires your Flask routes to be defined at the root (e.g., @main_bp.route('/crud'))
    location ~ ^/(crud|edit|import|download-template|logout) {
         proxy_pass http://billing_app:5000;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Location 5: For the billing homepage
    location /billing/ {
        proxy_pass http://billing_app:5000/;
    }

    # Location for File System Main Pages
    # Catches /files and /health
    location ~ ^/(files|admin|trash|preview|api_file|health|auth) {
    # location ~ ^/(files|trash|preview|api_file|health) {
        proxy_pass http://file_system_app_node:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /css/ {
        proxy_pass http://file_system_app:3000/css/;
    }
    location /js/ {
        proxy_pass http://file_system_app:3000/js/;
    }
    location /fs-api/ {
    proxy_pass http://file_system_app_node:3000/fs-api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
}
